<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定子产线不良品记录系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 原有的CSS样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* ... 其他样式保持不变 ... */
    </style>
</head>

<body>
    <div class="container">
        <!-- 页面结构保持不变 -->
    </div>

    <!-- 删除确认对话框 -->
    <div id="deleteModal" class="delete-modal">
        <div class="delete-modal-content">
            <div class="delete-modal-header">
                <span class="delete-modal-title">确认删除</span>
                <span id="deleteModalClose" class="delete-modal-close">&times;</span>
            </div>
            <div class="delete-modal-message">
                <p>您确定要删除这条记录吗？</p>
                <p class="text-danger">此操作不可撤销！</p>
            </div>
            <div class="delete-modal-actions">
                <button type="button" id="confirmDelete" class="btn btn-danger">确认删除</button>
                <button type="button" id="cancelDelete" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <!-- 添加Firebase SDK -->
    <script type="module">
        // 导入Firebase模块
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";

        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDuknMmqAIKt-bvVkx-bVq8K1liuE4mR04",
            authDomain: "my-data-ca1c8.firebaseapp.com",
            projectId: "my-data-ca1c8",
            storageBucket: "my-data-ca1c8.firebasestorage.app",
            messagingSenderId: "385667932458",
            appId: "1:385667932458:web:007e20290412ff1b91be53",
            measurementId: "G-EMKWK3M4KY"
        };

        // 初始化Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // 获取所有必要的 DOM 元素
        const recordForm = document.getElementById('recordForm');
        const defectList = document.getElementById('defectList');
        const emptyDefects = document.getElementById('emptyDefects');
        const totalDefects = document.getElementById('totalDefects');
        const previewDate = document.getElementById('previewDate');
        const previewLine = document.getElementById('previewLine');
        const previewModel = document.getElementById('previewModel');
        const previewRecorder = document.getElementById('previewRecorder');
        const previewTotalDefects = document.getElementById('previewTotalDefects');
        const previewDefectTypes = document.getElementById('previewDefectTypes');
        const recordHistory = document.getElementById('recordHistory');
        const recordCount = document.getElementById('recordCount');
        const totalRecords = document.getElementById('totalRecords');
        const totalDefectsStat = document.getElementById('totalDefectsStat');
        const addDefect = document.getElementById('addDefect');
        const exportAllRecords = document.getElementById('exportAllRecords');
        const exportSelectedRecords = document.getElementById('exportSelectedRecords');
        const deleteSelectedRecords = document.getElementById('deleteSelectedRecords');
        const selectAllRecords = document.getElementById('selectAllRecords');
        const selectedCount = document.getElementById('selectedCount');
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalClose = document.getElementById('deleteModalClose');
        const confirmDelete = document.getElementById('confirmDelete');
        const cancelDelete = document.getElementById('cancelDelete');

        // 存储所有记录
        let records = [];
        let currentDeleteRecordId;

        // 添加不良品项目
        addDefect.addEventListener('click', function () {
            const defectType = document.getElementById('defectType');
            const defectQuantity = document.getElementById('defectQuantity');

            if (defectType.value && defectQuantity.value > 0) {
                const newDefect = document.createElement('div');
                newDefect.classList.add('defect-item');
                newDefect.innerHTML = `
                    <div>${defectType.value}</div>
                    <div>${defectQuantity.value}</div>
                    <div>
                        <button type="button" class="btn btn-remove btn-sm">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                `;

                defectList.appendChild(newDefect);
                emptyDefects.style.display = 'none';

                // 计算总不良品数量
                let total = 0;
                const defectItems = defectList.querySelectorAll('.defect-item:not(:first-child)');
                defectItems.forEach(item => {
                    total += parseInt(item.children[1].textContent);
                });
                totalDefects.textContent = total;
                previewTotalDefects.textContent = total;

                // 更新预览的不良品类型
                const defectTypes = [];
                defectItems.forEach(item => {
                    defectTypes.push(item.children[0].textContent);
                });
                previewDefectTypes.textContent = defectTypes.join(', ');

                // 绑定删除按钮事件
                const removeButton = newDefect.querySelector('.btn-remove');
                removeButton.addEventListener('click', function () {
                    newDefect.remove();
                    if (defectList.children.length === 2) {
                        emptyDefects.style.display = 'block';
                    }

                    // 重新计算总不良品数量
                    let newTotal = 0;
                    const newDefectItems = defectList.querySelectorAll('.defect-item:not(:first-child)');
                    newDefectItems.forEach(item => {
                        newTotal += parseInt(item.children[1].textContent);
                    });
                    totalDefects.textContent = newTotal;
                    previewTotalDefects.textContent = newTotal;

                    // 更新预览的不良品类型
                    const newDefectTypes = [];
                    newDefectItems.forEach(item => {
                        newDefectTypes.push(item.children[0].textContent);
                    });
                    previewDefectTypes.textContent = newDefectTypes.join(', ') || '无';
                });
            }
        });

        // 提交记录到Firestore
        recordForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const recordDate = document.getElementById('recordDate').value;
            const productionLine = document.getElementById('productionLine').value;
            const productModel = document.getElementById('productModel').value;
            const recorder = document.getElementById('recorder').value;
            const remark = document.getElementById('remark').value;
            const defectItems = defectList.querySelectorAll('.defect-item:not(:first-child)');
            const defects = [];
            let total = 0;

            defectItems.forEach(item => {
                const type = item.children[0].textContent;
                const quantity = parseInt(item.children[1].textContent);
                defects.push({ type, quantity });
                total += quantity;
            });

            const newRecord = {
                date: recordDate,
                line: productionLine,
                model: productModel,
                recorder,
                defects,
                totalDefects: total,
                remark,
                timestamp: new Date().getTime()
            };

            try {
                // 添加到Firestore
                const docRef = await addDoc(collection(db, "records"), newRecord);
                console.log("记录已添加，ID: ", docRef.id);
                
                // 重置表单
                recordForm.reset();
                defectList.innerHTML = `
                    <div class="defect-item">
                        <div>不良品类型</div>
                        <div>数量</div>
                        <div>操作</div>
                    </div>
                    <div class="empty-state" id="emptyDefects">暂无不良品记录，请添加项目</div>
                `;
                totalDefects.textContent = 0;
                previewDate.textContent = '未选择';
                previewLine.textContent = '未选择';
                previewModel.textContent = '未填写';
                previewRecorder.textContent = '未填写';
                previewTotalDefects.textContent = 0;
                previewDefectTypes.textContent = '无';
            } catch (error) {
                console.error("添加记录失败: ", error);
                alert("添加记录失败，请重试");
            }
        });

        // 从Firestore获取记录
        const fetchRecords = async () => {
            try {
                // 创建按时间戳降序排列的查询
                const q = query(collection(db, "records"), orderBy("timestamp", "desc"));
                
                // 设置实时监听
                onSnapshot(q, (snapshot) => {
                    records = [];
                    snapshot.forEach((doc) => {
                        const record = doc.data();
                        record.id = doc.id; // 添加文档ID
                        records.push(record);
                    });
                    updateRecordHistory();
                    updateStats();
                });
            } catch (error) {
                console.error("获取记录失败: ", error);
            }
        };

        // 更新记录历史
        function updateRecordHistory() {
            recordHistory.innerHTML = '';
            const sortedRecords = sortRecords(records);
            const filteredRecords = filterRecords(sortedRecords);

            if (filteredRecords.length === 0) {
                recordHistory.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <i class="fas fa-database" style="font-size: 3rem; color: #dadce0; margin-bottom: 15px;"></i>
                        <p style="color: var(--secondary);">暂无记录数据</p>
                    </div>
                `;
                return;
            }

            const dateGroups = {};
            filteredRecords.forEach(record => {
                if (!dateGroups[record.date]) {
                    dateGroups[record.date] = [];
                }
                dateGroups[record.date].push(record);
            });

            for (const date in dateGroups) {
                const dateGroup = document.createElement('div');
                dateGroup.classList.add('date-group');
                dateGroup.innerHTML = `
                    <div class="date-header">
                        <span>${date}</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="date-records">
                        ${dateGroups[date].map(record => `
                            <div class="record-item">
                                <input type="checkbox" class="record-checkbox" data-id="${record.id}">
                                <div class="record-header">
                                    <h4>生产产线: ${record.line}线</h4>
                                    <span class="record-time">提交时间: ${new Date(record.timestamp).toLocaleString()}</span>
                                </div>
                                <div class="record-preview-grid">
                                    <div class="record-preview-item">
                                        <div class="record-preview-label">产品型号</div>
                                        <div class="record-preview-value">${record.model}</div>
                                    </div>
                                    <div class="record-preview-item">
                                        <div class="record-preview-label">记录人员</div>
                                        <div class="record-preview-value">${record.recorder}</div>
                                    </div>
                                    <div class="record-preview-item">
                                        <div class="record-preview-label">不良品总数</div>
                                        <div class="record-preview-value">${record.totalDefects}</div>
                                    </div>
                                    <div class="record-preview-item">
                                        <div class="record-preview-label">不良品类型</div>
                                        <div class="record-preview-value">${record.defects.map(defect => defect.type).join(', ')}</div>
                                    </div>
                                </div>
                                <div class="record-actions">
                                    <button type="button" class="btn btn-delete btn-sm" data-id="${record.id}">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                recordHistory.appendChild(dateGroup);

                // 绑定折叠/展开事件
                const dateHeader = dateGroup.querySelector('.date-header');
                dateHeader.addEventListener('click', function () {
                    dateGroup.classList.toggle('collapsed');
                });

                // 绑定单个删除按钮事件
                const deleteButtons = dateGroup.querySelectorAll('.btn-delete');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        currentDeleteRecordId = this.dataset.id;
                        deleteModal.style.display = 'block';
                    });
                });
            }

            // 绑定全选/反选事件
            selectAllRecords.addEventListener('change', function () {
                const checkboxes = recordHistory.querySelectorAll('.record-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSelectedCount();
            });

            // 绑定单个复选框事件
            const checkboxes = recordHistory.querySelectorAll('.record-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateSelectedCount();
                });
            });

            recordCount.textContent = `已保存 ${filteredRecords.length} 条记录`;
        }

        // 更新统计信息
        function updateStats() {
            totalRecords.textContent = records.length;
            let totalDefectsSum = 0;
            records.forEach(record => {
                totalDefectsSum += record.totalDefects;
            });
            totalDefectsStat.textContent = totalDefectsSum;
        }

        // 排序记录
        function sortRecords(records) {
            const sortField = document.getElementById('sortField').value;
            const sortOrder = document.getElementById('sortOrder').value;

            return records.sort((a, b) => {
                let valueA, valueB;
                switch (sortField) {
                    case 'date':
                        valueA = a.date;
                        valueB = b.date;
                        break;
                    case 'line':
                        valueA = parseInt(a.line);
                        valueB = parseInt(b.line);
                        break;
                    case 'defects':
                        valueA = a.totalDefects;
                        valueB = b.totalDefects;
                        break;
                    case 'timestamp':
                        valueA = a.timestamp;
                        valueB = b.timestamp;
                        break;
                }

                if (sortOrder === 'asc') {
                    return valueA - valueB;
                } else {
                    return valueB - valueA;
                }
            });
        }

        // 筛选记录
        function filterRecords(records) {
            const filterLine = document.getElementById('filterLine').value;
            if (filterLine) {
                return records.filter(record => record.line === filterLine);
            }
            return records;
        }

        // 更新选中记录数量
        function updateSelectedCount() {
            const checkboxes = recordHistory.querySelectorAll('.record-checkbox');
            let count = 0;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    count++;
                }
            });
            selectedCount.textContent = count;
            deleteSelectedRecords.disabled = count === 0;
        }

        // 导出所有记录
        exportAllRecords.addEventListener('click', function () {
            const ws = XLSX.utils.json_to_sheet(records);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '不良品记录');
            XLSX.writeFile(wb, '不良品记录_所有记录.xlsx');
        });

        // 导出选中记录
        exportSelectedRecords.addEventListener('click', function () {
            const checkboxes = recordHistory.querySelectorAll('.record-checkbox');
            const selectedRecords = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const recordId = checkbox.dataset.id;
                    const record = records.find(record => record.id === recordId);
                    if (record) {
                        selectedRecords.push(record);
                    }
                }
            });

            if (selectedRecords.length > 0) {
                const ws = XLSX.utils.json_to_sheet(selectedRecords);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '不良品记录');
                XLSX.writeFile(wb, '不良品记录_选中记录.xlsx');
            }
        });

        // 批量删除选中记录
        deleteSelectedRecords.addEventListener('click', async function () {
            const checkboxes = recordHistory.querySelectorAll('.record-checkbox');
            const selectedIds = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedIds.push(checkbox.dataset.id);
                }
            });

            if (selectedIds.length > 0) {
                try {
                    for (const id of selectedIds) {
                        await deleteDoc(doc(db, "records", id));
                    }
                    selectAllRecords.checked = false;
                    updateSelectedCount();
                } catch (error) {
                    console.error("批量删除记录失败: ", error);
                    alert("批量删除记录失败");
                }
            }
        });

        // 关闭删除确认对话框
        deleteModalClose.addEventListener('click', function () {
            deleteModal.style.display = 'none';
        });

        cancelDelete.addEventListener('click', function () {
            deleteModal.style.display = 'none';
        });

        // 确认删除单条记录
        confirmDelete.addEventListener('click', async function () {
            try {
                await deleteDoc(doc(db, "records", currentDeleteRecordId));
                deleteModal.style.display = 'none';
            } catch (error) {
                console.error("删除记录失败: ", error);
                alert("删除记录失败");
            }
        });

        // 表单输入实时预览
        recordForm.addEventListener('input', function () {
            previewDate.textContent = document.getElementById('recordDate').value || '未选择';
            previewLine.textContent = document.getElementById('productionLine').value ? `${document.getElementById('productionLine').value}线` : '未选择';
            previewModel.textContent = document.getElementById('productModel').value || '未填写';
            previewRecorder.textContent = document.getElementById('recorder').value || '未填写';
        });

        // 初始化时获取记录
        fetchRecords();

        // 添加排序和筛选的事件监听
        document.getElementById('sortField').addEventListener('change', updateRecordHistory);
        document.getElementById('sortOrder').addEventListener('change', updateRecordHistory);
        document.getElementById('filterLine').addEventListener('change', updateRecordHistory);
    </script>
</body>

</html>