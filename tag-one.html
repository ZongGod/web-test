<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定子不良品记录系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#6B7280',
                        accent: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444',
                        neutral: '#F3F4F6'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuknMmqAIKt-bvVkx-bVq8K1liuE4mR04",
            authDomain: "my-data-ca1c8.firebaseapp.com",
            projectId: "my-data-ca1c8",
            storageBucket: "my-data-ca1c8.firebasestorage.app",
            messagingSenderId: "385667932458",
            appId: "1:385667932458:web:007e20290412ff1b91be53",
            measurementId: "G-EMKWK3M4KY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            // 获取DOM元素
            const recordForm = document.getElementById('recordForm');
            const defectList = document.getElementById('defectList');
            const totalDefects = document.getElementById('totalDefects');
            const recordHistory = document.getElementById('recordHistory');
            const recordCount = document.getElementById('recordCount');
            const totalRecords = document.getElementById('totalRecords');
            const addDefectBtn = document.getElementById('addDefectBtn');
            const emptyDefects = document.getElementById('emptyDefects');
            
            // 不良品类型下拉选项
            const defectTypes = [
                "表面划痕", "尺寸偏差", "裂纹", "变形", "杂质", "毛刺", "颜色不均", 
                "组装不良", "材料缺陷", "其他"
            ];
            
            // 添加不良品项目
            addDefectBtn.addEventListener('click', () => {
                // 隐藏空状态提示
                if (emptyDefects) {
                    emptyDefects.style.display = 'none';
                }
                
                // 创建不良品项目
                const defectItem = document.createElement('div');
                defectItem.className = 'defect-item';
                defectItem.innerHTML = `
                    <div class="defect-type flex items-center">
                        <select class="border rounded px-2 py-1 bg-white w-full">
                            ${defectTypes.map(type => `<option>${type}</option>`).join('')}
                        </select>
                    </div>
                    <div class="defect-quantity flex items-center">
                        <input type="number" value="1" min="1" class="border rounded px-2 py-1 w-full text-center">
                    </div>
                    <div class="defect-actions flex items-center justify-center">
                        <button type="button" class="btn-remove-defect text-danger hover:text-danger/80 transition-colors">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // 添加到列表
                defectList.appendChild(defectItem);
                
                // 更新总数
                updateTotalDefects();
                
                // 添加删除事件
                const removeBtn = defectItem.querySelector('.btn-remove-defect');
                removeBtn.addEventListener('click', () => {
                    defectItem.remove();
                    updateTotalDefects();
                    
                    // 检查是否还有项目
                    if (defectList.querySelectorAll('.defect-item:not(:first-child)').length === 0 && emptyDefects) {
                        emptyDefects.style.display = 'block';
                    }
                });
                
                // 更新预览
                updatePreview();
            });
            
            // 更新不良品总数
            function updateTotalDefects() {
                const defectItems = defectList.querySelectorAll('.defect-item:not(:first-child)');
                let total = 0;
                
                defectItems.forEach(item => {
                    const quantity = parseInt(item.querySelector('input[type="number"]').value);
                    total += quantity;
                });
                
                totalDefects.textContent = total;
            }
            
            // 为输入框添加数量变化事件
            defectList.addEventListener('change', (e) => {
                if (e.target.type === 'number') {
                    updateTotalDefects();
                    updatePreview();
                }
            });
            
            // 更新表单预览
            function updatePreview() {
                const previewContainer = document.getElementById('previewContainer');
                const defectItems = defectList.querySelectorAll('.defect-item:not(:first-child)');
                
                if (defectItems.length === 0) {
                    previewContainer.innerHTML = `
                        <div class="bg-neutral p-4 rounded-lg text-center text-secondary">
                            <i class="fa fa-info-circle mr-2"></i>请添加不良品记录以查看预览
                        </div>
                    `;
                    return;
                }
                
                const recordDate = document.getElementById('recordDate').value || '未选择';
                const productionLine = document.getElementById('productionLine').value || '未选择';
                const productModel = document.getElementById('productModel').value || '未填写';
                const recorder = document.getElementById('recorder').value || '未填写';
                const remark = document.getElementById('remark').value || '无';
                
                let defectsHTML = '';
                let totalDefectCount = 0;
                
                defectItems.forEach((item, index) => {
                    const type = item.querySelector('select').value;
                    const quantity = parseInt(item.querySelector('input[type="number"]').value);
                    totalDefectCount += quantity;
                    
                    defectsHTML += `
                        <div class="flex justify-between py-1 border-b last:border-0">
                            <span class="text-gray-600">${index + 1}. ${type}</span>
                            <span class="font-medium">${quantity} 件</span>
                        </div>
                    `;
                });
                
                previewContainer.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-medium text-primary">记录预览</h4>
                            <span class="text-xs text-secondary">总计: ${totalDefectCount} 件</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">记录日期</div>
                                <div class="font-medium">${recordDate}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">生产产线</div>
                                <div class="font-medium">${productionLine}线</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">产品型号</div>
                                <div class="font-medium">${productModel}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">记录人员</div>
                                <div class="font-medium">${recorder}</div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="text-xs text-gray-500 mb-1">不良品明细</div>
                            <div class="bg-neutral rounded p-3">
                                ${defectsHTML}
                            </div>
                        </div>
                        
                        <div>
                            <div class="text-xs text-gray-500 mb-1">备注与建议</div>
                            <div class="text-sm">${remark}</div>
                        </div>
                    </div>
                `;
            }
            
            // 表单提交处理
            recordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // 获取表单数据
                const recordDate = document.getElementById('recordDate').value;
                const productionLine = document.getElementById('productionLine').value;
                const productModel = document.getElementById('productModel').value;
                const recorder = document.getElementById('recorder').value;
                const defectItems = defectList.querySelectorAll('.defect-item:not(:first-child)');
                
                // 验证必填字段
                if (!recordDate || !productionLine || !productModel || !recorder || defectItems.length === 0) {
                    alert('请填写所有必填字段并添加至少一项不良品记录');
                    return;
                }
                
                // 处理不良品数据
                const defects = Array.from(defectItems).map(item => ({
                    type: item.querySelector('select').value,
                    quantity: parseInt(item.querySelector('input[type="number"]').value)
                }));
                
                const totalDefectCount = defects.reduce((sum, defect) => sum + defect.quantity, 0);
                const remark = document.getElementById('remark').value;
                
                try {
                    // 保存数据到 Firebase Firestore
                    await addDoc(collection(db, 'records'), {
                        recordDate,
                        productionLine,
                        productModel,
                        recorder,
                        defects,
                        totalDefectCount,
                        remark,
                        timestamp: new Date()
                    });
                    
                    // 显示成功提示
                    showToast('记录提交成功！', 'success');
                    
                    // 重置表单
                    recordForm.reset();
                    defectList.innerHTML = `
                        <div class="defect-item">
                            <div>不良品类型</div>
                            <div>数量</div>
                            <div>操作</div>
                        </div>
                        <div class="empty-state" id="emptyDefects">暂无不良品记录，请添加项目</div>
                    `;
                    totalDefects.textContent = '0';
                    updatePreview();
                    
                } catch (error) {
                    console.error('Error adding document: ', error);
                    showToast('记录提交失败，请重试！', 'error');
                }
            });
            
            // 显示提示消息
            function showToast(message, type = 'info') {
                const toastContainer = document.createElement('div');
                toastContainer.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full opacity-0 ${
                    type === 'success' ? 'bg-success text-white' : 
                    type === 'error' ? 'bg-danger text-white' : 
                    'bg-primary text-white'
                }`;
                toastContainer.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(toastContainer);
                
                // 显示提示
                setTimeout(() => {
                    toastContainer.classList.remove('translate-x-full', 'opacity-0');
                }, 10);
                
                // 自动隐藏
                setTimeout(() => {
                    toastContainer.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        document.body.removeChild(toastContainer);
                    }, 300);
                }, 3000);
            }
            
            // 实时监听记录变化
            const q = query(collection(db, 'records'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    const record = doc.data();
                    record.id = doc.id;
                    records.push(record);
                });
                
                // 更新记录历史列表
                updateRecordHistory(records);
            });
            
            // 更新记录历史列表
            function updateRecordHistory(records) {
                recordHistory.innerHTML = '';
                recordCount.textContent = `已保存 ${records.length} 条记录`;
                totalRecords.textContent = records.length;
                
                if (records.length === 0) {
                    recordHistory.innerHTML = `
                        <div class="text-center py-10 text-secondary">
                            <div class="text-4xl mb-3">
                                <i class="fa fa-database text-gray-300"></i>
                            </div>
                            <p>暂无记录数据，提交后记录将显示在此处</p>
                        </div>
                    `;
                    return;
                }
                
                records.forEach(record => {
                    const recordItem = document.createElement('div');
                    recordItem.className = 'record-item bg-white rounded-lg shadow-sm border border-gray-100 mb-3 overflow-hidden transition-all hover:shadow-md';
                    
                    // 格式化时间
                    const timestamp = new Date(record.timestamp.toMillis());
                    const formattedTime = timestamp.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // 不良品类型列表
                    const defectTypes = record.defects.map(defect => defect.type).join(', ');
                    
                    recordItem.innerHTML = `
                        <div class="record-header bg-neutral px-4 py-3 flex justify-between items-center">
                            <h4 class="font-medium text-primary">${record.productModel}</h4>
                            <span class="text-xs text-secondary">${formattedTime}</span>
                        </div>
                        <div class="record-content p-4">
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <div class="text-xs text-gray-500">记录日期</div>
                                    <div class="font-medium">${record.recordDate}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">生产产线</div>
                                    <div class="font-medium">${record.productionLine}线</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">记录人员</div>
                                    <div class="font-medium">${record.recorder}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">不良品总数</div>
                                    <div class="font-medium">${record.totalDefectCount} 件</div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="text-xs text-gray-500">不良品类型</div>
                                    <div class="font-medium text-sm">${defectTypes}</div>
                                </div>
                            </div>
                            
                            ${record.remark ? `
                                <div class="mb-3">
                                    <div class="text-xs text-gray-500">备注与建议</div>
                                    <div class="text-sm text-gray-600">${record.remark}</div>
                                </div>
                            ` : ''}
                            
                            <div class="defects-details">
                                <div class="text-xs text-gray-500 mb-2">不良品明细</div>
                                <div class="bg-neutral rounded p-3">
                                    ${record.defects.map((defect, index) => `
                                        <div class="flex justify-between py-1 border-b last:border-0">
                                            <span class="text-gray-600">${index + 1}. ${defect.type}</span>
                                            <span class="font-medium">${defect.quantity} 件</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="record-actions bg-gray-50 px-4 py-2 flex justify-end">
                            <button type="button" class="btn-delete text-danger hover:text-danger/80 text-sm transition-colors flex items-center" data-id="${record.id}">
                                <i class="fa fa-trash mr-1"></i> 删除
                            </button>
                        </div>
                    `;
                    
                    recordHistory.appendChild(recordItem);
                });
                
                // 添加删除按钮事件
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const recordId = e.currentTarget.getAttribute('data-id');
                        if (confirm('确定要删除这条记录吗？')) {
                            try {
                                await deleteDoc(doc(db, 'records', recordId));
                                showToast('记录已删除！', 'success');
                            } catch (error) {
                                console.error('Error deleting document: ', error);
                                showToast('删除失败，请重试！', 'error');
                            }
                        }
                    });
                });
            }
            
            // 初始化预览
            updatePreview();
        });
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .defect-item {
                display: grid;
                grid-template-columns: 1fr 1fr 30px;
                gap: 8px;
                padding: 8px;
                border-bottom: 1px solid #f0f0f0;
            }
            .defect-item:first-child {
                font-weight: 600;
                background-color: #f8fafc;
            }
            .record-item {
                transition: all 0.2s ease;
            }
            .record-item:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }
            .animate-fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>

<body class="bg-gray-50 font-inter">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- 页面标题 -->
        <header class="mb-8">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-gray-800">定子不良品记录系统</h1>
            <p class="text-gray-500 mt-1">实时记录和管理生产过程中的不良品信息</p>
        </header>
        
        <!-- 主要内容区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧：记录表单 -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-plus-circle text-primary mr-2"></i>
                        新增不良品记录
                    </h2>
                    
                    <form id="recordForm" class="space-y-4">
                        <!-- 基本信息 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="recordDate" class="block text-sm font-medium text-gray-700 mb-1">记录日期 <span class="text-danger">*</span></label>
                                <input type="date" id="recordDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors" required>
                            </div>
                            <div>
                                <label for="productionLine" class="block text-sm font-medium text-gray-700 mb-1">生产产线 <span class="text-danger">*</span></label>
                                <select id="productionLine" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors" required>
                                    <option value="">请选择产线</option>
                                    <option value="1">1号线</option>
                                    <option value="2">2号线</option>
                                    <option value="3">3号线</option>
                                    <option value="4">4号线</option>
                                    <option value="5">5号线</option>
                                </select>
                            </div>
                            <div>
                                <label for="productModel" class="block text-sm font-medium text-gray-700 mb-1">产品型号 <span class="text-danger">*</span></label>
                                <input type="text" id="productModel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors" required>
                            </div>
                            <div>
                                <label for="recorder" class="block text-sm font-medium text-gray-700 mb-1">记录人员 <span class="text-danger">*</span></label>
                                <input type="text" id="recorder" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors" required>
                            </div>
                        </div>
                        
                        <!-- 不良品列表 -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">不良品记录 <span class="text-danger">*</span></label>
                                <button type="button" id="addDefectBtn" class="text-primary hover:text-primary/80 text-sm flex items-center transition-colors">
                                    <i class="fa fa-plus-circle mr-1"></i> 添加项目
                                </button>
                            </div>
                            
                            <div class="bg-white rounded-md border border-gray-200 overflow-hidden">
                                <div id="defectList" class="divide-y divide-gray-100">
                                    <div class="defect-item">
                                        <div>不良品类型</div>
                                        <div>数量</div>
                                        <div>操作</div>
                                    </div>
                                    <div class="empty-state" id="emptyDefects" style="grid-column: 1 / span 3; padding: 12px; text-align: center; color: #6B7280;">
                                        暂无不良品记录，请添加项目
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-2 text-right text-sm">
                                <span class="text-gray-600">总计: </span>
                                <span id="totalDefects" class="font-medium text-primary">0</span>
                                <span class="text-gray-600"> 件</span>
                            </div>
                        </div>
                        
                        <!-- 备注 -->
                        <div>
                            <label for="remark" class="block text-sm font-medium text-gray-700 mb-1">备注与建议</label>
                            <textarea id="remark" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors resize-none"></textarea>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="flex justify-end pt-2">
                            <button type="submit" class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded-md transition-colors flex items-center">
                                <i class="fa fa-save mr-2"></i> 提交记录
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- 表单预览 -->
                <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-eye text-primary mr-2"></i>
                        记录预览
                    </h2>
                    <div id="previewContainer">
                        <div class="bg-neutral p-4 rounded-lg text-center text-secondary">
                            <i class="fa fa-info-circle mr-2"></i>请添加不良品记录以查看预览
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：记录历史 -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <i class="fa fa-history text-primary mr-2"></i>
                            记录历史
                        </h2>
                        <div class="text-sm text-gray-500">
                            已保存 <span id="recordCount">0</span>
                        </div>
                    </div>
                    
                    <div class="overflow-y-auto max-h-[calc(100vh-300px)]" id="recordHistory">
                        <div class="text-center py-10 text-secondary">
                            <div class="text-4xl mb-3">
                                <i class="fa fa-database text-gray-300"></i>
                            </div>
                            <p>暂无记录数据，提交后记录将显示在此处</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm py-4 border-t border-gray-200">
            <p>定子不良品记录系统 &copy; 2023</p>
            <p class="mt-1">实时记录，高效管理</p>
        </footer>
    </div>
</body>
</html>